steps:
    - name: gcr.io/cloud-builders/docker
      args:
          [
              'buildx',
              'build',
              '--platform',
              'linux/amd64',
              '--build-arg',
              'JWT_ACCESS_TOKEN_TIME',
              '--build-arg',
              'JWT_REFRESH_TOKEN_TIME',
              '--build-arg',
              'MODE',
              '--build-arg',
              'AWS_IMAGE_BASEURL',
              '--build-arg',
              'SLACK_TOKEN',
              '--build-arg',
              'MONGODB_URI',
              '--build-arg',
              'JWT_SECRET_KEY',
              '--build-arg',
              'INTERATIONS',
              '--build-arg',
              'DKLEN',
              '--build-arg',
              'HASH',
              '-t',
              '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_IMAGE}:$COMMIT_SHA',
              '-f',
              'dockers/admin-server/Dockerfile',
              '.',
          ]
      secretEnv:
          [
              'JWT_ACCESS_TOKEN_TIME',
              'JWT_REFRESH_TOKEN_TIME',
              'MODE',
              'AWS_IMAGE_BASEURL',
              'SLACK_TOKEN',
              'MONGODB_URI',
              'JWT_SECRET_KEY',
              'INTERATIONS',
              'DKLEN',
              'HASH',
          ]
    - name: 'gcr.io/cloud-builders/docker'
      args: ['push', '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_IMAGE}:$COMMIT_SHA']
    - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
      entrypoint: gcloud
      args:
          [
              'run',
              'deploy',
              '${_SERVICE_NAME}',
              '--image',
              '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_IMAGE}:$COMMIT_SHA',
              '--region',
              '${_LOCATION}',
          ]
availableSecrets:
    secretManager:
        - versionName: projects/${_PROJECT_ID}/secrets/ADMIN_JWT_ACCESS_TOKEN_TIME/versions/latest
          env: 'JWT_ACCESS_TOKEN_TIME'
        - versionName: projects/${_PROJECT_ID}/secrets/ADMIN_JWT_REFRESH_TOKEN_TIME/versions/latest
          env: 'JWT_REFRESH_TOKEN_TIME'
        - versionName: projects/${_PROJECT_ID}/secrets/MODE_PROD/versions/latest
          env: 'MODE'
        - versionName: projects/${_PROJECT_ID}/secrets/AWS_PROD_IMAGE_BASEURL/versions/latest
          env: 'AWS_IMAGE_BASEURL'
        - versionName: projects/${_PROJECT_ID}/secrets/SLACK_TOKEN/versions/latest
          env: 'SLACK_TOKEN'
        - versionName: projects/${_PROJECT_ID}/secrets/MONGODB_PROD_URI/versions/latest
          env: 'MONGODB_URI'
        - versionName: projects/${_PROJECT_ID}/secrets/ADMIN_JWT_SECRET_KEY/versions/latest
          env: 'JWT_SECRET_KEY'
        - versionName: projects/${_PROJECT_ID}/secrets/INTERATIONS/versions/latest
          env: 'INTERATIONS'
        - versionName: projects/${_PROJECT_ID}/secrets/DKLEN/versions/latest
          env: 'DKLEN'
        - versionName: projects/${_PROJECT_ID}/secrets/HASH/versions/latest
          env: 'HASH'
images:
    - '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_IMAGE}:$COMMIT_SHA'
